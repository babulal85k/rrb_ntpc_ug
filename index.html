<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RRB NTPC UG Syllabus Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chosen Palette: Calm Neutrals (Beige, Slate, and Blue) -->
    <!-- Application Structure Plan: A single-page, public syllabus tracker. Info architecture includes a profile section, a public leaderboard, an overall progress bar (for the current user), and accordions for syllabus topics. All user data (profile, progress) is stored in a public Firestore collection `public/data/userProgress`, with each user's data in a document named after their `userId`. This allows all users to read the collection for the leaderboard, while each user only writes to their own document. -->
    <!-- Visualization & Content Choices: Report Info: RRB NTPC UG Syllabus. Goal: Track completion publicly. Presentation: Interactive Accordion List + Public Leaderboard (Top 10). Interaction: Checkboxes update progress bars (for current user) and save to Firestore. Leaderboard auto-updates. Justification: This structure meets the new "public" requirement. The leaderboard (a dynamic HTML list) shows top users, while the rest of the UI remains familiar for the current user to track their own progress. -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        details > summary {
            list-style: none;
        }
        details > summary::-webkit-details-marker {
            display: none;
        }
        details[open] > summary .arrow-down {
            transform: rotate(180deg);
        }
        .progress-bar-container {
            width: 100%;
            background-color: #e0e0e0;
            border-radius: 9999px;
            overflow: hidden;
            height: 2rem;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }
        .progress-bar-inner {
            background-color: #2563eb;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            width: 0%;
            border-radius: 9999px;
            transition: width 0.5s ease-in-out;
            font-weight: 500;
            font-size: 0.875rem;
        }
        .summary-progress-bar-container {
            width: 100%;
            background-color: #e0e0e0;
            border-radius: 9999px;
            overflow: hidden;
            height: 1.25rem;
        }
        .summary-progress-bar-inner {
            background-color: #1d4ed8;
            height: 100%;
            width: 0%;
            border-radius: 9999px;
            transition: width 0.5s ease-in-out;
            font-size: 0.75rem;
            color: white;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 0.5rem;
        }
        #status-message {
            transition: opacity 0.5s ease-in-out;
        }
    </style>
</head>
<body class="bg-stone-50 text-stone-800 min-h-screen p-4 md:p-8">

    <div class="max-w-4xl mx-auto">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-blue-800 mb-2">RRB NTPC (UG) Syllabus Tracker</h1>
            <p class="text-lg text-stone-600">Track your preparation progress alongside others.</p>
        </header>

        <main>
            <section class="bg-white p-6 rounded-xl shadow-lg mb-6">
                <h2 class="text-xl font-semibold mb-3 text-stone-800">Your Profile</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="md:col-span-1">
                        <label for="user-name" class="block text-sm font-medium text-stone-600 mb-1">Name</label>
                        <input type="text" id="user-name" class="w-full p-2 border border-stone-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="Enter your name">
                    </div>
                    <div class="md:col-span-1">
                        <label for="user-city" class="block text-sm font-medium text-stone-600 mb-1">City</label>
                        <input type="text" id="user-city" class="w-full p-2 border border-stone-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="Enter your city">
                    </div>
                    <div class="md:col-span-1 flex items-end">
                        <button id="save-profile-btn" class="w-full bg-blue-600 text-white py-2 px-4 rounded-lg font-medium hover:bg-blue-700 transition-colors shadow-md">Save Profile</button>
                    </div>
                </div>
                <div id="status-message" class="text-sm text-stone-500 mt-2 h-5 opacity-0"></div>
            </section>

            <section class="bg-white p-6 rounded-xl shadow-lg mb-8">
                <h2 class="text-xl font-semibold mb-3 text-stone-800">Your Overall Progress</h2>
                <div id="total-progress-container" class="progress-bar-container">
                    <div id="total-progress-bar" class="progress-bar-inner">0%</div>
                </div>
            </section>

            <section class="bg-white p-6 rounded-xl shadow-lg mb-8">
                <h2 class="text-xl font-semibold mb-4 text-stone-800">Public Progress (Top 10)</h2>
                <div id="leaderboard-container" class="space-y-3 max-h-60 overflow-y-auto pr-2">
                    <p id="leaderboard-loading" class="text-stone-500">Loading public progress...</p>
                </div>
            </section>

            <section id="syllabus-container" class="space-y-4"></section>
        </main>
        
        <footer class="text-center mt-12 text-stone-500 text-sm">
            <p>Syllabus based on official RRB NTPC notifications. Always cross-verify with the latest official documents.</p>
        </footer>
    </div>

    <script type="module">
        import { initializeApp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const syllabusData = [
            {
                id: 'math',
                title: 'Mathematics',
                topics: [
                    { id: 'math-1', name: 'Number System' },
                    { id: 'math-2', name: 'Decimals' },
                    { id: 'math-3', name: 'Fractions' },
                    { id: 'math-4', name: 'LCM and HCF' },
                    { id: 'math-5', name: 'Ratio and Proportion' },
                    { id: 'math-6', name: 'Percentage' },
                    { id: 'math-7', name: 'Mensuration' },
                    { id: 'math-8', name: 'Time and Work' },
                    { id: 'math-9', name: 'Time and Distance' },
                    { id: 'math-10', name: 'Simple and Compound Interest' },
                    { id: 'math-11', name: 'Profit and Loss' },
                    { id: 'math-12', name: 'Elementary Algebra' },
                    { id: 'math-13', name: 'Geometry and Trigonometry' },
                    { id: 'math-14', name: 'Elementary Statistics' }
                ]
            },
            {
                id: 'reasoning',
                title: 'General Intelligence and Reasoning',
                topics: [
                    { id: 'reasoning-1', name: 'Analogies' },
                    { id: 'reasoning-2', name: 'Completion of Number and Alphabetical Series' },
                    { id: 'reasoning-3', name: 'Coding and Decoding' },
                    { id: 'reasoning-4', name: 'Mathematical Operations' },
                    { id: 'reasoning-5', name: 'Similarities and Differences' },
                    { id: 'reasoning-6', name: 'Relationships' },
                    { id: 'reasoning-7', name: 'Analytical Reasoning' },
                    { id: 'reasoning-8', name: 'Syllogism' },
                    { id: 'reasoning-9', name: 'Jumbling' },
                    { id: 'reasoning-10', name: 'Venn Diagrams' },
                    { id: 'reasoning-11', name: 'Puzzle' },
                    { id: 'reasoning-12', name: 'Data Sufficiency' },
                    { id: 'reasoning-13', name: 'Statement-Conclusion' },
                    { id: 'reasoning-14', name: 'Statement-Courses of Action' },
                    { id: 'reasoning-15', name: 'Decision Making' },
                    { id: 'reasoning-16', name: 'Maps and Interpretation of Graphs' }
                ]
            },
            {
                id: 'ga',
                title: 'General Awareness',
                topics: [
                    { id: 'ga-1', name: 'Current Events of National and International Importance' },
                    { id: 'ga-2', name: 'Games and Sports' },
                    { id: 'ga-3', name: 'Art and Culture of India' },
                    { id: 'ga-4', name: 'Indian Literature' },
                    { id: 'ga-5', name: 'Monuments and Places of India' },
                    { id: 'ga-6', name: 'General Science and Life Science (up to 10th CBSE)' },
                    { id: 'ga-7', name: 'History of India and Freedom Struggle' },
                    { id: 'ga-8', name: 'Physical, Social and Economic Geography of India and World' },
                    { id: 'ga-9', name: 'Indian Polity and Governance - Constitution and Political System' },
                    { id: 'ga-10', name: 'General Scientific and Technological Developments' },
                    { id: 'ga-11', name: 'UN and Other Important World Organizations' },
                    { id: 'ga-12', name: 'Environmental Issues Concerning India and World' },
                    { id: 'ga-13', name: 'Basics of Computers and Computer Applications' },
                    { id: 'ga-14', name: 'Common Abbreviations' },
                    { id: 'ga-15', name: 'Transport Systems in India' },
                    { id: 'ga-16', name: 'Indian Economy' },
                    { id: 'ga-17', name: 'Famous Personalities of India and World' },
                    { id: 'ga-18', name: 'Flagship Government Programs' },
                    { id: 'ga-19', name: 'Flora and Fauna of India' },
                    { id: 'ga-20', name: 'Important Government and Public Sector Organizations of India' }
                ]
            }
        ];

        let progressState = {};
        let app, db, auth;
        let userId = null;
        let userDocRef = null;
        let unsubscribeSyllabus = null;
        let unsubscribeLeaderboard = null;
        let statusTimeout = null;
        const dataCollectionPath = 'userProgress'; // Simpler path

        document.addEventListener('DOMContentLoaded', () => {
            initializeFirebase();
            renderSyllabus(); 
            document.getElementById('save-profile-btn').addEventListener('click', saveProfile);
        });

        function initializeFirebase() {
            try {
                // --- 🔴 STOP! READ THIS TO FIX THE ERROR 🔴 ---
                // You MUST replace "YOUR_API_KEY", "YOUR_PROJECT_ID", etc.,
                // with the real values from your own Firebase project.
                
                // 🟢 PASTE YOUR FIREBASE CONFIG OBJECT HERE 🟢
                const firebaseConfig = {
                  apiKey: "AIzaSyCL68wVkFc_HwrOxGGR764kHxGg-BYzue8",
                  authDomain: "rrb-data.firebaseapp.com",
                  projectId: "rrb-data",
                  storageBucket: "rrb-data.firebasestorage.app",
                  messagingSenderId: "357911744671",
                  appId: "1:357911744671:web:80733c361c99ee385612aa",
                  measurementId: "G-DG39RCS1TJ"
                };
                // --- END OF CONFIG ---

                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('Debug');

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        userDocRef = doc(db, dataCollectionPath, userId);
                        
                        // Setup listeners *after* user is authenticated
                        setupSyllabusListener();
                        setupPublicLeaderboardListener();

                    } else {
                        try {
                            await signInAnonymously(auth);
                        } catch (error) {
                            console.error("Authentication error:", error);
                            showStatus("Error: Could not authenticate user.");
                        }
                    }
                });
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                showStatus("Error: Could not connect to database.");
            }
        }

        // Sets up the listener for the CURRENT user's data
        function setupSyllabusListener() {
            if (unsubscribeSyllabus) {
                unsubscribeSyllabus();
            }
            if (!userDocRef) return;

            showStatus("Loading your progress...");
            unsubscribeSyllabus = onSnapshot(userDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    progressState = data.progress || {};
                    document.getElementById('user-name').value = data.name || '';
                    document.getElementById('user-city').value = data.city || '';
                } else {
                    progressState = {};
                    document.getElementById('user-name').value = '';
                    document.getElementById('user-city').value = '';
                }
                updateCheckboxesFromState();
                updateAllProgress();
                showStatus("Your progress is synced.", 2000);
            }, (error) => {
                console.error("Firestore listener error:", error);
                showStatus("Error: Could not sync your progress.");
            });
        }

        // Sets up the listener for ALL users' data (the leaderboard)
        // --- THIS FUNCTION IS NOW FIXED (using your suggested scope) ---
        // --- AND UPDATED for the "Top 10" feature ---
        function setupPublicLeaderboardListener() {
            if (unsubscribeLeaderboard) {
                unsubscribeLeaderboard();
            }

            // FIX: Get elements outside the snapshot listener
            const leaderboardContainer = document.getElementById('leaderboard-container');
            const loadingEl = document.getElementById('leaderboard-loading');
            
            // NEW: Create the query for Top 10 by percentage
            const leaderboardCollectionRef = collection(db, dataCollectionPath);
            const leaderboardQuery = query(leaderboardCollectionRef, orderBy("percentage", "desc"), limit(10));

            unsubscribeLeaderboard = onSnapshot(leaderboardQuery, (querySnapshot) => {
                
                if (querySnapshot.empty) {
                    if(loadingEl) loadingEl.textContent = 'No public progress found yet.';
                    return;
                }

                let allUsersProgress = [];
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    if (data.name) { // Only show users who have saved a name
                        allUsersProgress.push({
                            name: data.name,
                            city: data.city || 'Unknown',
                            // Use the stored percentage
                            percentage: data.percentage || 0 
                        });
                    }
                });

                // No longer need client-side sort!
                // allUsersProgress.sort((a, b) => b.percentage - a.percentage);

                // Render
                leaderboardContainer.innerHTML = ''; // Clear loading/old data
                allUsersProgress.forEach(user => {
                    const userHtml = `
                        <div class="flex justify-between items-center bg-stone-50 p-3 rounded-lg">
                            <div>
                                <p class="font-semibold text-stone-700">${user.name}</p>
                                <p class="text-sm text-stone-500">${user.city}</p>
                            </div>
                            <div class="font-semibold text-blue-600 text-lg">${Math.round(user.percentage)}%</div>
                        </div>
                    `;
                    leaderboardContainer.innerHTML += userHtml;
                });

            }, (error) => {
                console.error("Leaderboard listener error:", error);
                // FIX: This now works because leaderboardContainer is in scope
                if (leaderboardContainer) {
                    leaderboardContainer.innerHTML = '<p class="text-red-500">Error loading public progress. Check console for details.</p>';
                }
            });
        }

        // Helper function to calculate total progress % from a progress object
        function calculateProgressPercentage(progressObject) {
            let totalTopics = 0;
            let totalCompleted = 0;
            
            for (const section of syllabusData) {
                totalTopics += section.topics.length;
                for (const topic of section.topics) {
                    if (progressObject[topic.id]) {
                        totalCompleted++;
                    }
                }
            }
            return totalTopics > 0 ? (totalCompleted / totalTopics) * 100 : 0;
        }

        function renderSyllabus() {
            const container = document.getElementById('syllabus-container');
            container.innerHTML = '';

            for (const section of syllabusData) {
                const detailsElement = document.createElement('details');
                detailsElement.className = 'bg-white rounded-xl shadow-lg overflow-hidden';
                
                const summaryElement = document.createElement('summary');
                summaryElement.className = 'p-5 cursor-pointer flex justify-between items-center hover:bg-stone-50 transition-colors';
                
                summaryElement.innerHTML = `
                    <div class="flex-1">
                        <h3 class="text-xl font-semibold text-blue-700">${section.title}</h3>
                        <div class="mt-2 pr-4">
                            <div class="summary-progress-bar-container">
                                <div id="${section.id}-progress-bar" class="summary-progress-bar-inner">
                                    <span id="${section.id}-progress-text" class="text-xs font-medium">0%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="arrow-down text-blue-700 transition-transform duration-300">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16">
                            <path fill-rule="evenodd" d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z"/>
                        </svg>
                    </div>
                `;
                
                const topicsListContainer = document.createElement('div');
                topicsListContainer.className = 'p-5 border-t border-stone-200';
                
                const topicsList = document.createElement('ul');
                topicsList.className = 'space-y-3';
                
                for (const topic of section.topics) {
                    const listItem = document.createElement('li');
                    listItem.className = 'flex items-center';
                    
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.id = topic.id;
                    checkbox.dataset.topicId = topic.id;
                    checkbox.dataset.sectionId = section.id;
                    checkbox.className = 'h-5 w-5 rounded text-blue-600 border-stone-300 focus:ring-blue-500 cursor-pointer';
                    
                    checkbox.addEventListener('change', handleCheckboxChange);
                    
                    const label = document.createElement('label');
                    label.htmlFor = topic.id;
                    label.textContent = topic.name;
                    label.className = 'ml-3 text-stone-700 cursor-pointer';
                    
                    listItem.appendChild(checkbox);
                    listItem.appendChild(label);
                    topicsList.appendChild(listItem);
                }
                
                topicsListContainer.appendChild(topicsList);
                detailsElement.appendChild(summaryElement);
                detailsElement.appendChild(topicsListContainer);
                container.appendChild(detailsElement);
            }
        }

        function updateCheckboxesFromState() {
            const checkboxes = document.querySelectorAll('input[type="checkbox"][data-topic-id]');
            checkboxes.forEach(checkbox => {
                const topicId = checkbox.dataset.topicId;
                checkbox.checked = !!progressState[topicId];
            });
        }

        function handleCheckboxChange(event) {
            const topicId = event.target.dataset.topicId;
            if (event.target.checked) {
                progressState[topicId] = true;
            } else {
                delete progressState[topicId];
            }
            saveProgressToFirestore(); // This will also trigger the leaderboard update
            updateAllProgress(); 
        }

        async function saveProgressToFirestore() {
            if (!userDocRef) return;
            const name = document.getElementById('user-name').value;
            const city = document.getElementById('user-city').value;
            // NEW: Calculate percentage on save
            const percentage = calculateProgressPercentage(progressState); 

            try {
                // Save progress, name, city, and percentage together
                await setDoc(userDocRef, { 
                    progress: progressState,
                    name: name,
                    city: city,
                    percentage: percentage // NEW: Save percentage
                }, { merge: true });
                showStatus("Progress saved.", 2000);
            } catch (error) {
                console.error("Error saving progress:", error);
                showStatus("Error: Could not save progress.");
            }
        }

        async function saveProfile() {
            if (!userDocRef) return;

            const name = document.getElementById('user-name').value;
            const city = document.getElementById('user-city').value;
            // NEW: Also save percentage when profile is saved
            const percentage = calculateProgressPercentage(progressState);

            try {
                // Save profile data (which also triggers leaderboard update)
                await setDoc(userDocRef, { 
                    name: name, 
                    city: city,
                    percentage: percentage // NEW: Save percentage
                }, { merge: true });
                showStatus("Profile saved.", 2000);
            } catch (error) {
                console.error("Error saving profile:", error);
                showStatus("Error: Could not save profile.");
            }
        }

        // Updates the progress bars for the CURRENT user
        function updateAllProgress() {
            let totalTopics = 0;
            let totalCompleted = 0;

            for (const section of syllabusData) {
                let sectionTopics = section.topics.length;
                let sectionCompleted = 0;
                
                for (const topic of section.topics) {
                    if (progressState[topic.id]) { // Uses global progressState
                        sectionCompleted++;
                    }
                }

                totalTopics += sectionTopics;
                totalCompleted += sectionCompleted;

                const sectionPercentage = sectionTopics > 0 ? (sectionCompleted / sectionTopics) * 100 : 0;
                
                const sectionBar = document.getElementById(`${section.id}-progress-bar`);
                const sectionText = document.getElementById(`${section.id}-progress-text`);
                
                if (sectionBar) {
                    sectionBar.style.width = `${sectionPercentage}%`;
                }
                if (sectionText) {
                    sectionText.textContent = `${Math.round(sectionPercentage)}%`;
                    if (sectionPercentage < 30) {
                        sectionText.classList.add('justify-end', 'pr-2');
                        sectionText.classList.remove('justify-center');
                    } else {
                        sectionText.classList.remove('justify-end', 'pr-2');
                        sectionText.classList.add('justify-center');
                    }
                }
            }

            const totalPercentage = totalTopics > 0 ? (totalCompleted / totalTopics) * 100 : 0;
            
            const totalBar = document.getElementById('total-progress-bar');
            
            if (totalBar) {
                totalBar.style.width = `${totalPercentage}%`;
                totalBar.textContent = `${Math.round(totalPercentage)}%`;
            }
        }

        function showStatus(message, duration = 0) {
            const statusEl = document.getElementById('status-message');
            if (!statusEl) return;

            if (statusTimeout) {
                clearTimeout(statusTimeout);
            }

            statusEl.textContent = message;
            statusEl.classList.remove('opacity-0');

            if (duration > 0) {
                statusTimeout = setTimeout(() => {
                    statusEl.classList.add('opacity-0');
                    statusTimeout = null;
                }, duration);
            }
        }

    </script>
</body>
</html>

